<!DOCTYPE HTML>
<html>
    <head>
        <title>Физическое моделирование воды</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div id="A4">
            <p id="section">
                Физическое моделирование воды
            </p>
            
            <p id="small">
                (https://gamedev.ru/code/articles/?id=4205)
            </p>

            <p id="plane">
                Эффект водной глади является желанным гостем в трехмерной графике. 
                В краткой заметке я попытаюсь рассказать про физическое моделирование. 
                Побудительными мотивами являются следующие обстоятельства. Во-первых,
                довольно абстрактная <i>mIRC</i> лекция <i>Yann L.</i>, посвященная моделированию воды. 
                Безусловно очень компетентного и знающего человека. Однако, 
                в лекции допущены грубые неточности. Его реализация (которая, вопреки 
                заявленному, не имеет к уравнению Навье-Стокса ни малейшего отношения) 
                не является оптимальной с точки зрения сеточных методов решения дифференциальных
                уравнений. В короткий промежуток времени мне на глаза попалось и другое 
                воплощение. Тоже весьма некачественное.
            </p>

            <p id="plane">
                В заметке будет рассказано о самом общеупотребительном сеточном методе решения 
                уравнения колебаний: 
            </p>

            <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                <semantics>
                 <mrow>
                  <mfrac>
                   <mrow>
                    <msup>
                     <mi>d</mi>
                     <mn>2</mn>
                    </msup>
                    <mi>U</mi>
                   </mrow>
                   <msup>
                    <mi mathvariant="italic">dt</mi>
                    <mn>2</mn>
                   </msup>
                  </mfrac>
                  <mo stretchy="false">=</mo>
                  <mrow>
                   <mfrac>
                    <mrow>
                     <msup>
                      <mi>d</mi>
                      <mn>2</mn>
                     </msup>
                     <mi>U</mi>
                    </mrow>
                    <msup>
                     <mi mathvariant="italic">dx</mi>
                     <mn>2</mn>
                    </msup>
                   </mfrac>
                   <mo stretchy="false">+</mo>
                   <mfrac>
                    <mrow>
                     <msup>
                      <mi>d</mi>
                      <mn>2</mn>
                     </msup>
                     <mi>U</mi>
                    </mrow>
                    <msup>
                     <mi mathvariant="italic">dy</mi>
                     <mn>2</mn>
                    </msup>
                   </mfrac>
                  </mrow>
                 </mrow>
                 <annotation encoding="StarMath 5.0">{ d^2 U } over { dt^2 } = { d^2 U } over { dx^2 } + { d^2 U } over { dy^2 }</annotation>
                </semantics>
               </math>

            <p id="plane">
               Здесь <i>t</i> - время, <i>x,y</i> - координаты. Решая это уравнение, мы получим очень 
               реалистичную поверхность воды. Кроме того, в статье будет приведен очень быстрый 
               (и правильный с точки зрения математики) расчет нормалей без вычисления обратного 
               квадратного корня и векторных произведений.
            </p>

            <p id="plane">
                Не надо пугаться страшных непонятных буковок в уравнении (*). Дальнейшее изложение 
                не требует понимания того, что именно там написано.
            </p>

            <p id="plane">
                Итак, некоторые определения: вершина (нормаль и координата), и массив, содержащий числа. 
                Эти самые числа будут интерпретированы как высота поверхности воды в регулярной сетке. 
                Нам надо завести два таких массива, и мы будем переключаться между ними по надобности. 
            </p>

            <pre id="code">
    struct vertex
    {
        float coo[3];
        float nor[3];
    };

    struct field
    {
        float U[128][128];
    };

    vertex vertices[128][128];
    field A,B;
    field *p=&A,*n=&B;
            </pre>

            <p id="plane">
                А вот и основной шаг программы:
            </p>

            <pre id="code">
    void time_step()
    {
        int i,j,i1,j1;
        i1=rand()%110;
        j1=rand()%110;
    
        /*1*/
    
        if((rand()&127)==0)
    
        for(i=-3;i<4;i++) {
            for(j=-3;j<4;j++) {
                float v=6.0f-i*i-j*j;
                if(v<0.0f)v=0.0f;
                n->U[i+i1+3][j+j1+3]-=v*0.004f;
            }
        }
    
        for(i=1;i<127;i++) {
            for(j=1;j<127;j++) {
                /*2*/
                vertices[i][j].coo[2]=n->U[i][j];
                vertices[i][j].nor[0]=n->U[i-1][j]-n->U[i+1][j];
                vertices[i][j].nor[1]=n->U[i][j-1]-n->U[i][j+1];
                /*3*/
                #define vis 0.005f 
                float laplas=(n->U[i-1][j]+
                n->U[i+1][j]+
                n->U[i][j+1]+
                n->U[i][j-1])*0.25f-n->U[i][j];
                /*4*/
                p→U[i][j]=((2.0f-vis)*n→U[i][j]-p→U[i][j]*(1.0f-vis)+laplas);
            }
        }
        /*5*/
        for(i=1;i<127;i++) {
            glBegin(GL_TRIANGLE_STRIP);
            for(j=1;j<127;j++) {
                glNormal3fv(vertices[i][j].nor);
                glVertex3fv(vertices[i][j].coo);
                glNormal3fv(vertices[i+1][j].nor);
                glVertex3fv(vertices[i+1][j].coo);
            }
            glEnd();
        }
    
        /*6*/
        field *sw=p;p=n;n=sw;
    }
            </pre>

            <p id="tip">
                
            </p>

            <p id="plane">
               
            </p>
        
            <p id="subsection">
               
            </p>

            <p id="tip">
                
            </p>

            <p id="plane">
                
            </p>
        </page>
    </body>
</html>